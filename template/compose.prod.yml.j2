networks:
  {{ project_name }}:
    name: {{ project_name }}
  alltuner-network:
    external: true
    name: alltuner-network

services:
{%- if enable_job_queue %}
  {{ project_name }}-worker:
  image: alltuner-registry.long-python.ts.net/{{ project_name }}:latest
  restart: unless-stopped
  env_file:
    - .env
  networks:
    - {{ project_name }}
    - alltuner-network
  command: ['worker']
  labels:
    managed_by: "all-tuner"
{%- if enable_watchtower %}
    com.centurylinklabs.watchtower.enable: "true"
{%- endif %}
{%- endif %}
  {{ project_name }}:
    build:
      context: .
      args:
        VERSION: ${VERSION:-0.0.0}
        PYTHON_VERSION: ${PYTHON_VERSION:-{{ python_version }}}
        ENVIRONMENT: ${ENVIRONMENT:-development}
      x-bake:
        platforms:
          - linux/amd64
          - linux/arm64
        push: true
        tags:
          - alltuner-registry.long-python.ts.net/{{ project_name }}:${VERSION:-0.0.0}
          - alltuner-registry.long-python.ts.net/{{ project_name }}:latest
    image: alltuner-registry.long-python.ts.net/{{ project_name }}:latest
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:8000/debug/health')"
        ]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s
    restart: unless-stopped
    env_file:
      - .env
    networks:
      - {{ project_name }}
      - alltuner-network
    labels:
      managed_by: "all-tuner"
{%- if enable_watchtower %}
      com.centurylinklabs.watchtower.enable: "true"
{%- endif %}
{%- if fqdn %}
      caddy_0: {{ fqdn }}
      caddy_0.reverse_proxy: {% raw %}"{{upstreams 8000}}"{% endraw %}
      caddy_0.tls.dns: cloudflare ${CF_API_TOKEN}
      caddy_0.log.output: file /var/log/caddy/{{ fqdn }}.log
      caddy_0.log.output.import: log-rotation
      caddy_0.import: umami
{%- endif %}
      # Above this line, nothing should be changed
      # Below this line, nothing should be changed
# End of file: do not remove this line or add any content below
